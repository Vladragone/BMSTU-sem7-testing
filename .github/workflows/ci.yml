name: CI

on: [push, pull_request]

jobs:
  unit:
    runs-on: ubuntu-latest
    env:
      TEST_DB_NAME: game_test
      TEST_DB_USER: postgres
      TEST_DB_PASS: postgres
    steps:
      - uses: actions/checkout@v4
      - run: docker compose -f docker-compose.tests.yml up -d db
      - run: docker compose -f docker-compose.tests.yml run --rm tests "sed -i 's/\\r$//' mvnw scripts/*.sh && chmod +x mvnw scripts/*.sh && ./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipITs=true -Dallure.results.directory=allure-results/unit -Dallure.skip=true test"
      - if: always()
        run: docker compose -f docker-compose.tests.yml down -v

  it:
    runs-on: ubuntu-latest
    needs: unit
    env:
      TEST_DB_NAME: game_test
      TEST_DB_USER: postgres
      TEST_DB_PASS: postgres
    steps:
      - uses: actions/checkout@v4
      - run: docker compose -f docker-compose.tests.yml up -d db
      - run: docker compose -f docker-compose.tests.yml run --rm tests "sed -i 's/\\r$//' mvnw scripts/*.sh && chmod +x mvnw scripts/*.sh && ./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipTests=false -DskipITs=false -Dit.test='**/*ITCase' -Dallure.results.directory=allure-results/integration -Dallure.skip=true verify"
      - if: always()
        run: docker compose -f docker-compose.tests.yml down -v

  e2e:
    runs-on: ubuntu-latest
    needs: it
    env:
      TEST_DB_NAME: game_test
      TEST_DB_USER: postgres
      TEST_DB_PASS: postgres
    steps:
      - uses: actions/checkout@v4
      - run: docker compose -f docker-compose.tests.yml up -d db
      - run: docker compose -f docker-compose.tests.yml run --rm tests "sed -i 's/\\r$//' mvnw scripts/*.sh && chmod +x mvnw scripts/*.sh && ./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipTests=false -DskipITs=false -Dit.test='**/*E2ECase' -Dallure.results.directory=allure-results/e2e -Dallure.skip=true verify"
      - if: always()
        run: docker compose -f docker-compose.tests.yml down -v
