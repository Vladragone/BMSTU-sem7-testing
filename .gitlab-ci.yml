stages:
  - unit
  - integration
  - e2e
  - report

variables:
  DOCKER_TLS_CERTDIR: ""
  TEST_DB_NAME: "game_test"
  TEST_DB_USER: "postgres"
  TEST_DB_PASS: "postgres"

default:
  image: docker:27.3.1
  services:
    - name: docker:27.3.1-dind
  before_script:
    - apk add --no-cache docker-cli-compose bash
    - docker version

unit_tests:
  stage: unit
  script:
    - docker compose -f docker-compose.tests.yml build tests
    - docker compose -f docker-compose.tests.yml up -d db
    - docker compose -f docker-compose.tests.yml run --rm tests "./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipITs=true -Dallure.results.directory=target/allure-results/unit test"
  artifacts:
    when: always
    paths:
      - project-root/target/allure-results/unit
      - project-root/target/surefire-reports
    reports:
      junit: project-root/target/surefire-reports/*.xml
  after_script:
    - docker compose -f docker-compose.tests.yml down -v

integration_tests:
  stage: integration
  script:
    - docker compose -f docker-compose.tests.yml build tests
    - docker compose -f docker-compose.tests.yml up -d db
    - docker compose -f docker-compose.tests.yml run --rm tests "./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipTests=true -DskipITs=false -Dit.test='**/*ITCase' -Dallure.results.directory=target/allure-results/integration verify"
  artifacts:
    when: always
    paths:
      - project-root/target/allure-results/integration
      - project-root/target/failsafe-reports
    reports:
      junit: project-root/target/failsafe-reports/*.xml
  after_script:
    - DB_CID=$(docker compose -f docker-compose.tests.yml ps -q db)
    - if [ -n "$DB_CID" ]; then docker exec -i "$DB_CID" psql -U "$TEST_DB_USER" -d "$TEST_DB_NAME" < project-root/src/test/resources/sql/clean.sql; fi
    - docker compose -f docker-compose.tests.yml down -v

e2e_tests:
  stage: e2e
  script:
    - docker compose -f docker-compose.tests.yml build tests
    - docker compose -f docker-compose.tests.yml up -d db
    - docker compose -f docker-compose.tests.yml run --rm tests "./scripts/wait-for-db.sh db 5432 60 && ./mvnw -B -DskipTests=true -DskipITs=false -Dit.test='**/*E2ECase' -Dallure.results.directory=target/allure-results/e2e verify"
  artifacts:
    when: always
    paths:
      - project-root/target/allure-results/e2e
      - project-root/target/failsafe-reports
    reports:
      junit: project-root/target/failsafe-reports/*.xml
  after_script:
    - DB_CID=$(docker compose -f docker-compose.tests.yml ps -q db)
    - if [ -n "$DB_CID" ]; then docker exec -i "$DB_CID" psql -U "$TEST_DB_USER" -d "$TEST_DB_NAME" < project-root/src/test/resources/sql/clean.sql; fi
    - docker compose -f docker-compose.tests.yml down -v

report:
  stage: report
  image: maven:3.9.6-eclipse-temurin-17
  needs:
    - job: unit_tests
      artifacts: true
    - job: integration_tests
      artifacts: true
      optional: true
    - job: e2e_tests
      artifacts: true
      optional: true
  when: always
  script:
    - cd project-root
    - chmod +x mvnw scripts/allure_report.sh
    - scripts/allure_report.sh
  artifacts:
    when: always
    paths:
      - project-root/target/site/allure-maven-plugin
      - project-root/target/allure-history
